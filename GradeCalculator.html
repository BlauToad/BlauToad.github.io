<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GradeCalculator</title>
</head>

<body>
    <div class="big">
        <input type="range" min="0" max="100" value="50" class="slider" id="_grade_percentage">
        <div class="outer">
            <div>
                <a id="_g_percentage">50%</a>
                <a>Grades:</a>
                <input id="_grades" title="Nr. of Grades" type="number" value="0" min="0" max="69">
                <br><br>
                <div id="_g">
                </div>
                <input id="_voc_average" title="VocAverage" type="number" disabled style="display: none;">
                <br>
                <a id="_g_average" class="average">0</a>
            </div>
            <div>
                <a id="_og_percentage">50%</a>
                <a>Oral Grades:</a>
                <input id="_o_grades" title="Nr. of Oral Grades" type="number" value="0" min="0" max="69">
                <br><br>
                <div id="_og">
                </div>
                <br>
                <a id="_o_average" class="average">0</a>
            </div>
            <div>
                <a>Vocab Grades:</a>
                <input id="_v_grades" title="Nr. of Vocab Grades" type="number" value="0" min="0" max="69">
                <br><br>
                <div id="_vg">
                </div>
                <br>
                <a id="_v_average" class="average">0</a>
            </div>
        </div>
        <a id="_total_average">0</a>
    </div>

    <style>
        body {
            background-color: #aaa;
        }

        .slider{
            margin-left: 1%;
            width: 60%;
        }

        .big {
            background-color: #888a;
            padding: 10px;
            border-radius: 10px;
        }

        .big>a{
            background-color: aqua;
            display: block;
            width: 89%;
            border-radius: 10px;
            padding-left: 10px;
            margin: 10px;
        }

        .outer {
            width: 100%;
            margin: 0;
            padding: 0;
            border-radius: 20px;
        }

        .outer>div {
            display: inline-block;
            width: 30%;
            background-color: #fffa;
            border-radius: 5px;
            padding: 0.5%;
            position: relative;
            vertical-align: top;
        }

        .outer>div>* {
            width: 95%;
        }

        .outer>div>div>* {
            width: 100%;
        }

        .average {
            background-color: #f00;
            border-radius: 10px;
            padding-left: 10px;
            padding-right: 10px;
            margin-left: 10px;
        }
    </style>
    <script>
        var xx_grades = [[],[],[]]
        var gotVariables = false;
        var g = document.getElementById("_g");
        var og = document.getElementById("_og");
        var vg = document.getElementById("_vg");
        var grades = document.getElementById("_grades");
        var o_grades = document.getElementById("_o_grades");
        var v_grades = document.getElementById("_v_grades");
        var v_grade_average = document.getElementById("_voc_average");
        var g_average = document.getElementById("_g_average");
        var o_average = document.getElementById("_o_average");
        var v_average = document.getElementById("_v_average");
        var t_average = document.getElementById("_total_average");
        var slider_percentage = document.getElementById("_grade_percentage");
        var g_percentage = document.getElementById("_g_percentage");
        var o_percentage = document.getElementById("_og_percentage");
        
        var nr_grades = [0, 0];
        var nr_o_grades = [0, 0];
        var nr_v_grades = [0, 0];
        setInterval(function () {
            //create new grade inputs
            while (grades.value > nr_grades[0]) {
                var i = createInput("grades_", nr_grades[0]);
                g.appendChild(i);
                nr_grades[0]++;
            }
            while (o_grades.value > nr_o_grades[0]) {
                var i = createInput("ogradeso_", nr_o_grades[0]);
                og.appendChild(i);
                nr_o_grades[0]++;
            }
            while (v_grades.value > nr_v_grades[0]) {
                var i = createInput("vgradesv_", nr_v_grades[0]);
                vg.appendChild(i);
                nr_v_grades[0]++;
            }
            // deactivate grade inputs
            while (grades.value < nr_grades[1]) {
                findEById("grades_", nr_grades[1] - 1).style.display = "none";
                nr_grades[1]--;
            }
            while (o_grades.value < nr_o_grades[1]) {
                findEById("ogradeso_", nr_o_grades[1] - 1).style.display = "none";
                nr_o_grades[1]--;
            }
            while (v_grades.value < nr_v_grades[1]) {
                findEById("vgradesv_", nr_v_grades[1] - 1).style.display = "none";
                nr_v_grades[1]--;
            }
            //activate grade inputs
            while (grades.value > nr_grades[1]) {
                findEById("grades_", nr_grades[1]).style.display = "block";
                nr_grades[1]++;
            }
            while (o_grades.value > nr_o_grades[1]) {
                findEById("ogradeso_", nr_o_grades[1]).style.display = "block";
                nr_o_grades[1]++;
            }
            while (v_grades.value > nr_v_grades[1]) {
                findEById("vgradesv_", nr_v_grades[1]).style.display = "block";
                nr_v_grades[1]++;
            }
            //calc average
            o_average.innerHTML = calcAverage("ogradeso_", o_grades.value)
            v_average.innerHTML = calcAverage("vgradesv_", v_grades.value)
            //hide / show voc average
            if (v_grades.value > 0) {
                v_grade_average.style.display = "block";
                v_grade_average.value = calcAverage("vgradesv_", v_grades.value);
                g_average.innerHTML = calcAverage("grades_", grades.value, [v_grade_average.value]);
            } else {
                v_grade_average.style.display = "none";
                g_average.innerHTML = calcAverage("grades_", grades.value);
            }
            //slider percentage
            g_percentage.innerHTML = slider_percentage.value + "%"
            o_percentage.innerHTML = (100 - slider_percentage.value) + "%"
            //total average
            t_average.innerHTML = parseFloat(g_average.innerHTML) * (slider_percentage.value/100) + parseFloat(o_average.innerHTML) * ((100 - slider_percentage.value)/100)
            //gotVariable
            if(gotVariables){
                for (let index = 0; index < xx_grades[0].length; index++) {
                    const element = xx_grades[0][index];
                    writeEById("grades_",index,element);
                }
                for (let index = 0; index < xx_grades[1].length; index++) {
                    const element = xx_grades[1][index];
                    writeEById("ogradeso_",index,element);
                }
                for (let index = 0; index < xx_grades[2].length; index++) {
                    const element = xx_grades[2][index];
                    writeEById("vgradesv_",index,element);
                }
                gotVariables = false;
            }
        }, 50);

        setInterval(function () {
            //changeURL
            var url = window.location.origin + window.location.pathname;
            url += "?percentage=" + slider_percentage.value;
            if(grades.value > 0){
                url += "?grades=[";
                for (let index = 0; index < grades.value; index++) {
                    const element = findEById("grades_",index).value;
                    url += element;
                    url += ","
                }
                url = url.slice(0,url.length-1);
                url += "]";
            }
            if(o_grades.value > 0){
                url += "?ogrades=[";
                for (let index = 0; index < o_grades.value; index++) {
                    const element = findEById("ogradeso_",index).value;
                    url += element;
                    url += ","
                }
                url = url.slice(0,url.length-1);
                url += "]";
            }
            if(v_grades.value > 0){
                url += "?vgrades=[";
                for (let index = 0; index < v_grades.value; index++) {
                    const element = findEById("vgradesv_",index).value;
                    url += element;
                    url += ","
                }
                url = url.slice(0,url.length-1);
                url += "]";
            }
            history.replaceState({id: 'Grade Calculator', source: 'JS'}, "Grade Calculator", url);
        }, 500)

        function calcAverage(prefix, max_id, additional_summands) {
            var i = 0;
            var sum = 0;
            for (var j = 0; j < max_id; j++) {
                x = document.getElementById(prefix + j + "_").value;
                i++;
                sum = sum + parseFloat(x);
            }
            if (additional_summands) {
                additional_summands.forEach(element => {
                    i++;
                    sum = sum + parseFloat(element);
                });
            }
            var r = 0;
            if (i != 0) {
                r = parseFloat(sum / i);
            }
            return r;
        }

        function createInput(prefix, suffix) {
            let input = document.createElement("input");
            input.type = "number";
            input.id = prefix + suffix + "_";
            input.value = "1"
            input.min = "0";
            input.max = "15"
            input.step = "0.25"
            return input;
        }

        function findEById(prefix, id) {
            return document.getElementById(prefix + id + "_");
        }

        function writeEById(prefix, id, value){
            findEById(prefix, id).value = value;
        }


        {
            var v = window.location.search.split("?");
            v.forEach(element => {
                var e = element.split("=");
                switch (e[0]) {
                    case "percentage":
                        slider_percentage.value = e[1];
                        break;
                    case "grades":
                        var f = e[1].replace("[","").replace("]","").split(",");
                        if(f[0]=="" && f.length == 1){f=[]}
                        grades.value = f.length;
                        xx_grades[0] = f;
                        gotVariables = true;
                        console.log(f);
                        break;
                    case "ogrades":
                        var f = e[1].replace("[","").replace("]","").split(",");
                        if(f[0]=="" && f.length == 1){f=[]}
                        o_grades.value = f.length;
                        xx_grades[1] = f;
                        gotVariables = true;
                        console.log(f);
                        break;
                    case "vgrades":
                        var f = e[1].replace("[","").replace("]","").split(",");
                        if(f[0]=="" && f.length == 1){f=[]}
                        v_grades.value = f.length;
                        xx_grades[2] = f;
                        gotVariables = true;
                        console.log(f);
                        break;
                    default:
                        break;
                }
            });
        }
    </script>
</body>

</html>